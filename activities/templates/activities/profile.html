{% extends "base.html" %}
{% load static %}

{% block title %}{% if user == request.user %}Mon Profil{% else %}Profil de {{ user.username }}{% endif %} - AirLibre{% endblock %}

{% block content %}
<section class="container">
    <div class="profile-container fade-in-up">
        <div class="row">
            <!-- Colonne de gauche : Informations du profil -->
            <div class="col-lg-4">
                <div class="profile-sidebar filters-card">
                    <div class="text-center mb-4">
                        <div class="profile-avatar-container">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" alt="Avatar de {{ user.username }}" class="profile-avatar">
                            {% else %}
                                <div class="profile-avatar-icon" role="img" aria-label="Avatar de {{ user.username }}">
                                    <i class="fas fa-user-circle" aria-hidden="true"></i>
                                </div>
                            {% endif %}
                        </div>
                        <h1 class="profile-name mt-3">{{ user.username }}</h1>
                    </div>
                    <div class="profile-info">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-envelope" aria-hidden="true"></i>
                            </div>
                            <div>
                                <strong>Courriel:</strong>
                                {{ user.email|default:"Non renseigné" }}
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-user" aria-hidden="true"></i>
                            </div>
                            <div>
                                <strong>Nom complet:</strong>
                                {% if user.first_name or user.last_name %}
                                {{ user.first_name }} {{ user.last_name }}
                                {% else %}
                                Non renseigné
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="profile-bio mt-4">
                        <h2><i class="fas fa-quote-left me-2 text-success" aria-hidden="true"></i>Biographie</h2>
                        <p class="mt-2">
                            {{ user.bio | default:"Aucune biographie renseignée." }}
                        </p>
                    </div>

                    <!-- Bouton modifier profil - Affiché seulement pour son propre profil -->
                    {% if user == request.user %}
                    <div class="mt-4">
                        <div class="d-grid">
                            <a href="{% url 'edit_profile' %}" class="btn btn-details"
                                aria-label="Modifier mon profil utilisateur">
                                <i class="fas fa-edit me-2" aria-hidden="true"></i>
                                Modifier mon profil
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="filters-card mt-4">
                    <h2><i class="fas fa-chart-line me-2 text-success" aria-hidden="true"></i>Statistiques</h2>

                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="stat-number" aria-describedby="activities-created-label">
                                {{ activities_proposed.count }}</div>
                            <div class="stat-label" id="activities-created-label">Activités créées</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-number" aria-describedby="inscriptions-label">
                                {{ activities_attending.count }}
                            </div>
                            <div class="stat-label" id="inscriptions-label">Inscriptions</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne de droite : Activités et inscriptions -->
            <div class="col-lg-8">
                <!-- Activités créées -->
                <section class="filters-card" aria-labelledby="my-activities-heading">
                    <!-- Header section responsive -->
                    <div class="row align-items-center mb-4">
                        <div class="col-12 col-sm-8">
                            <h2 id="my-activities-heading" class="mb-0">
                                <i class="fas fa-mountain me-2 text-success" aria-hidden="true"></i>
                                {% if user == request.user %}Mes Activités{% else %}Activités de {{ user.username }}{% endif %}
                            </h2>
                        </div>
                        {% if user == request.user %}
                        <div class="col-12 col-sm-4 mt-2 mt-sm-0">
                            <div class="d-grid">
                                <a href="#" class="btn btn-outline-success btn-sm"
                                    aria-label="Créer une nouvelle activité">
                                    <i class="fas fa-plus me-2" aria-hidden="true"></i>
                                    <span class="d-none d-md-inline">Créer une activité</span>
                                    <span class="d-md-none">Créer</span>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="row">
                        {% if recent_activities_proposed%}
                        {% for activity in recent_activities_proposed %}
                        <div class="col-md-6 mb-4">
                            <article class="activity-card h-100" aria-labelledby="activity-title-{{ activity.id }}">
                                <div class="card-header">
                                    <h3 id="activity-title-{{ activity.id }}" class="activity-title">
                                        {{ activity.title }}
                                    </h3>
                                    <div class="activity-meta">
                                        <span class="badge badge-primary">{{ activity.category }}</span>
                                        {% now "Y-m-d H:i" as current_time %}
                                        {% if activity.start_time|date:"Y-m-d H:i" > current_time %}
                                        <span class="badge bg-success ms-2">À venir</span>
                                        {% else %}
                                        <span class="badge bg-secondary ms-2">Passé</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-calendar" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Date:</strong>
                                            <time datetime="{{ activity.start_time|date:'Y-m-d\TH:i' }}">
                                                {{ activity.start_time|date:"d M Y à H:i" }}
                                            </time>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-users" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Participants:</strong>
                                            {{ activity.attendees.count }}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Lieu:</strong>
                                            {{ activity.location_city }}
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="row g-2">
                                            <div class="col-12 col-sm-12">
                                                <a href="{% url 'activity_detail' activity.id %}"
                                                    class="btn btn-details btn-sm w-100"
                                                    aria-label="Voir les détails de l'activité {{ activity.title }}">
                                                    <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                    <span class="d-none d-lg-inline">Voir détails</span>
                                                    <span class="d-lg-none">Détails</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="col-12">
                            <div class="alert alert-info text-center" role="alert">
                                <i class="fas fa-info-circle fa-2x mb-3" aria-hidden="true"></i>
                                <h3>Aucune activité créée</h3>
                                <p class="mb-0">
                                    {% if user == request.user %}
                                        Vous n'avez pas encore créé d'activités. Commencez par en créer une !
                                    {% else %}
                                        {{ user.username }} n'a pas encore créé d'activités.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Bouton "Voir plus" responsive -->
                    {% if activities_proposed.count > 2 %}
                    <div class="text-center mt-4">
                        <div class="row justify-content-center">
                            <div class="col-12 col-sm-8 col-md-6">
                                <button onclick="toggleAllActivities()" 
                                    class="btn btn-outline-success w-100"
                                    id="toggleActivitiesBtn"
                                    aria-label="{% if user == request.user %}Voir la liste complète de toutes mes activités{% else %}Voir la liste complète des activités de {{ user.username }}{% endif %}">
                                    <i class="fas fa-list-ul me-2" aria-hidden="true"></i>
                                    <span class="d-none d-sm-inline">
                                        {% if user == request.user %}Voir toutes mes activités{% else %}Voir toutes les activités{% endif %}
                                    </span>
                                    <span class="d-sm-none">
                                        {% if user == request.user %}Toutes mes activités{% else %}Toutes les activités{% endif %}
                                    </span>
                                    <i class="fas fa-arrow-down ms-2" aria-hidden="true" id="activitiesArrow"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Section pour afficher toutes les activités (cachée par défaut) -->
                    <div id="allActivitiesSection" class="mt-4" style="display: none;">
                        <div class="row">
                            {% for activity in activities_proposed %}
                            <div class="col-md-6 mb-4">
                                <article class="activity-card h-100" aria-labelledby="activity-title-{{ activity.id }}">
                                    <div class="card-header">
                                        <h3 id="activity-title-{{ activity.id }}" class="activity-title">
                                            {{ activity.title }}
                                        </h3>
                                        <div class="activity-meta">
                                            <span class="badge badge-primary">{{ activity.category }}</span>
                                            {% now "Y-m-d H:i" as current_time %}
                                            {% if activity.start_time|date:"Y-m-d H:i" > current_time %}
                                            <span class="badge bg-success ms-2">À venir</span>
                                            {% else %}
                                            <span class="badge bg-danger ms-2">Passé</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-calendar" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Date:</strong>
                                                <time datetime="{{ activity.start_time|date:'Y-m-d\TH:i' }}">
                                                    {{ activity.start_time|date:"d M Y à H:i" }}
                                                </time>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-users" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Participants:</strong>
                                                {{ activity.attendees.count }}
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Lieu:</strong>
                                                {{ activity.location_city }}
                                            </div>
                                        </div>
                                        <div class="card-actions">
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'activity_detail' activity.id %}"
                                                    class="btn btn-details flex-fill">
                                                    <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                    <span class="d-none d-lg-inline">Voir détails</span>
                                                    <span class="d-lg-none">Détails</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>

                <!-- Inscriptions -->
                <section class="filters-card mt-4" aria-labelledby="my-registrations-heading">
                    <div class="row align-items-center mb-4">
                        <div class="col-12">
                            <h2 id="my-registrations-heading" class="mb-0">
                                <i class="fas fa-ticket-alt me-2 text-success" aria-hidden="true"></i>
                                {% if user == request.user %}Mes Inscriptions{% else %}Inscriptions de {{ user.username }}{% endif %}
                            </h2>
                        </div>
                    </div>

                    <!-- Activités auxquelles je participe -->
                    <div class="row">
                        {% if recent_activities_attending %}
                        {% for activity in recent_activities_attending %}
                        <div class="col-md-6 mb-4">
                            <article class="activity-card h-100" aria-labelledby="registration-title-{{ activity.id }}">
                                <div class="card-header">
                                    <h3 id="registration-title-{{ activity.id }}" class="activity-title">
                                        {{ activity.title }}
                                    </h3>
                                    <div class="activity-meta">
                                        <span class="badge badge-primary">{{ activity.category }}</span>
                                        {% now "Y-m-d H:i" as current_time %}
                                        {% if activity.start_time|date:"Y-m-d H:i" > current_time %}
                                        <span class="badge bg-success ms-2">À venir</span>
                                        {% else %}
                                        <span class="badge bg-danger ms-2">Passé</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-calendar" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Date:</strong>
                                            <time datetime="{{ activity.start_time|date:'Y-m-d\TH:i' }}">
                                                {{ activity.start_time|date:"d M Y à H:i" }}
                                            </time>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-user" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Organisateur:</strong>
                                            {{ activity.proposer.first_name }}
                                            {{ activity.proposer.last_name|default:activity.proposer.username }}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-icon">
                                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                        </div>
                                        <div>
                                            <strong>Lieu:</strong>
                                            {{ activity.location_city }}
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="row g-2">
                                            <div class="col-12 col-sm-12">
                                                <a href="{% url 'activity_detail' activity.id %}"
                                                    class="btn btn-details btn-sm w-100"
                                                    aria-label="Voir les détails de l'activité {{ activity.title }}">
                                                    <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                    <span class="d-none d-lg-inline">Voir détails</span>
                                                    <span class="d-lg-none">Détails</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </article>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="col-12">
                            <div class="alert alert-info text-center" role="alert">
                                <i class="fas fa-info-circle fa-2x mb-3" aria-hidden="true"></i>
                                <h3>Aucune inscription</h3>
                                <p class="mb-0">
                                    {% if user == request.user %}
                                        Vous n'êtes inscrit à aucune activité. Découvrez les activités disponibles !
                                    {% else %}
                                        {{ user.username }} n'est inscrit à aucune activité.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Bouton "Voir plus" responsive pour inscriptions -->
                    {% if activities_attending.count > 2 %}
                    <div class="text-center mt-4">
                        <div class="row justify-content-center">
                            <div class="col-12 col-sm-8 col-md-6">
                                <button onclick="toggleAllRegistrations()" 
                                    class="btn btn-outline-success w-100"
                                    id="toggleRegistrationsBtn"
                                    aria-label="{% if user == request.user %}Voir la liste complète de toutes mes inscriptions{% else %}Voir la liste complète des inscriptions de {{ user.username }}{% endif %}">
                                    <i class="fas fa-ticket-alt me-2" aria-hidden="true"></i>
                                    <span class="d-none d-sm-inline">
                                        {% if user == request.user %}Voir toutes mes inscriptions{% else %}Voir toutes les inscriptions{% endif %}
                                    </span>
                                    <span class="d-sm-none">
                                        {% if user == request.user %}Toutes mes inscriptions{% else %}Toutes les inscriptions{% endif %}
                                    </span>
                                    <i class="fas fa-arrow-down ms-2" aria-hidden="true" id="registrationsArrow"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Section pour afficher toutes les inscriptions (cachée par défaut) -->
                    <div id="allRegistrationsSection" class="mt-4" style="display: none;">
                        <div class="row">
                            {% for activity in activities_attending %}
                            <div class="col-md-6 mb-4">
                                <article class="activity-card h-100" aria-labelledby="registration-title-{{ activity.id }}">
                                    <div class="card-header">
                                        <h3 id="registration-title-{{ activity.id }}" class="activity-title">
                                            {{ activity.title }}
                                        </h3>
                                        <div class="activity-meta">
                                            <span class="badge badge-primary">{{ activity.category }}</span>
                                            {% now "Y-m-d H:i" as current_time %}
                                            {% if activity.start_time|date:"Y-m-d H:i" > current_time %}
                                            <span class="badge bg-success ms-2">À venir</span>
                                            {% else %}
                                            <span class="badge bg-danger ms-2">Passé</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-calendar" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Date:</strong>
                                                <time datetime="{{ activity.start_time|date:'Y-m-d\TH:i' }}">
                                                    {{ activity.start_time|date:"d M Y à H:i" }}
                                                </time>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-users" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Participants:</strong>
                                                {{ activity.attendees.count }}
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                            </div>
                                            <div>
                                                <strong>Lieu:</strong>
                                                {{ activity.location_city }}
                                            </div>
                                        </div>
                                        <div class="card-actions">
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'activity_detail' activity.id %}"
                                                    class="btn btn-details flex-fill">
                                                    <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                    <span class="d-none d-lg-inline">Voir détails</span>
                                                    <span class="d-lg-none">Détails</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</section>

<script>
function toggleAllActivities() {
    const section = document.getElementById('allActivitiesSection');
    const button = document.getElementById('toggleActivitiesBtn');
    const arrow = document.getElementById('activitiesArrow');
    
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        arrow.className = 'fas fa-arrow-up ms-2';
        button.innerHTML = button.innerHTML.replace('Voir toutes', 'Masquer toutes');
    } else {
        section.style.display = 'none';
        arrow.className = 'fas fa-arrow-down ms-2';
        button.innerHTML = button.innerHTML.replace('Masquer toutes', 'Voir toutes');
    }
}

function toggleAllRegistrations() {
    const section = document.getElementById('allRegistrationsSection');
    const button = document.getElementById('toggleRegistrationsBtn');
    const arrow = document.getElementById('registrationsArrow');
    
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        arrow.className = 'fas fa-arrow-up ms-2';
        button.innerHTML = button.innerHTML.replace('Voir toutes', 'Masquer toutes');
    } else {
        section.style.display = 'none';
        arrow.className = 'fas fa-arrow-down ms-2';
        button.innerHTML = button.innerHTML.replace('Masquer toutes', 'Voir toutes');
    }
}
</script>
{% endblock %}